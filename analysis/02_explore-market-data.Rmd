---
title: "Exploration of the available data on market potential and competitors"
author: "Luke"
date: "2021-03-05"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---



```{r, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  autodep = TRUE,
  warning = FALSE,
  message = FALSE
)
```


```{r setup}
library("colorspace")
library("data.table")
library("dplyr")
library("ggplot2")
library("here")
library("GGally")
library("rrMD")
library("sf")
library("skimr")
library("stringr")
```


```{r dataLoad}
source("R/helpers_data-import.R" %>% here())
load_raw_data <- get_raw_data_loaders()
competitors <- load_raw_data$competitors() 
market_potential <- load_raw_data$market_potential() 
dep_poly <- load_raw_data$dep_poly16() 
client_shops <- load_raw_data$client_shops() %>% st_as_sf() %>% setDT()

# add sales to client shops
customer_spending <- load_raw_data$client_customers() %>% st_as_sf() %>% setDT()
customer_spending <- customer_spending[
  sales > 0,.(sales = sum(as.numeric(sales))), by = "pos_id"]
client_shops[customer_spending, sales := sales ,  on = "pos_id"]
```


## A first look

```{r head}
# market potential
head(market_potential)
# competitor information
head(competitors)
```


```{r skim}
skim(market_potential)

skim(competitors)
```


## Check the position of our client in the market

We only captured 0.3% of the national market, which means that we probably observe only a subset of the customers of our client.


```{r nationalMarketShare}
sum(client_shops$sales) / sum(market_potential$mp)
```

## Investigate department level statististics

The average sales of client and competitors shops are plausible.

```{r aggregateDep}
department_stats <- market_potential[
  , ID_DEP := substr(IRIS,0,2)
  ][, .(MARKET_POTENTIAL = sum(mp)), by = "ID_DEP"]

department_SALES <- client_shops[
  , ID_DEP := substr(IRIS,0,2)
  ][, .(CLIENT_SALES = sum(sales)), by = "ID_DEP"]

dep_poly <- st_transform(dep_poly,"WGS84")
competitors_dep <- competitors %>%
  st_as_sf(coords = c("longitude","latitude")) %>%
  `st_crs<-`(st_crs(dep_poly)) %>%
  select(SIREN) %>% 
  st_join(dep_poly %>% select(CODE_DEPT)) %>% 
  group_by(CODE_DEPT) %>% 
  summarise(N_COMPETITOR = n()) %>% 
  st_drop_geometry() %>% 
  setDT()

department_stats[department_SALES, CLIENT_SALES := CLIENT_SALES, on = "ID_DEP"]
department_stats[,CLIENT_MARKET_SHARE := CLIENT_SALES / MARKET_POTENTIAL]
department_stats[competitors_dep, N_COMPETITOR := N_COMPETITOR,
                 on = c(ID_DEP = "CODE_DEPT")]
department_stats[setDT(dep_poly),geometry := geometry, on = c(ID_DEP = "CODE_DEPT")]
department_stats <- department_stats %>% st_as_sf()

# our client shops have average sales of 1,6mio
avg_client_sales <- with(department_stats,
                         sum(CLIENT_SALES,na.rm = T)/63)
avg_client_sales

# our competitors shops have average sales of 0,4mio
avg_compet_sales <- with(department_stats,
                         sum(MARKET_POTENTIAL)/sum(N_COMPETITOR))
avg_client_sales
```


Our clients market share goes up when there is higher market potential and more competitors.
Which means that he focusses probably on attractive spots in the market.


```{r}
department_stats %>% st_drop_geometry() %>% select(-ID_DEP) %>% 
  ggpairs( ) + theme_rrMD()

```


```{r}
ggplot(department_stats) +
  geom_point(aes(y = MARKET_POTENTIAL/N_COMPETITOR, x = ID_DEP)) +
  geom_point(aes(y = CLIENT_SALES, x = ID_DEP), col = "red") +
  geom_hline(aes(yintercept = avg_compet_sales)) +
  geom_hline(aes(yintercept = avg_client_sales), col = "red") +
  scale_y_log10(
    breaks = c(10^(0:12)),
    minor_breaks = log10_minor_break(),
    labels = scales::trans_format("log10", scales::math_format(10^.x)),
    limits = c(NA,10^7)
  ) + theme_rrMD() + theme(axis.text.x = element_text(angle = 65))
```

