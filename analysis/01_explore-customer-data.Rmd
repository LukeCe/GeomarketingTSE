---
title: "Exploration of the available data on customers and point of sales"
author: "Lukas Dargel"
date: "2021-03-04"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE,
  collapse = TRUE,
  comment = "#>",
  autodep = TRUE,
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library("colorspace")
library("data.table")
library("dplyr")
library("ggplot2")
library("here")
library("Hmisc")
library("rrMD")
library("sf")
library("skimr")
source("R/helper-03_data-prep-od-pairs.R" %>% here())
```


```{r dataLoad}
source("R/helpers_data-import.R" %>% here())
load_raw_data <- get_raw_data_loaders()
customer_flows <- load_raw_data$client_customers() %>% st_as_sf()
client_shops <- load_raw_data$client_shops() %>% st_as_sf()
departments <- load_raw_data$dep_poly16()
```


## A firs glance

A first look at the customer data reveals the following:

- every client is only 1 time in the database
- there are 63 destinations (pos_id)
- 0.2% of iris are missing
- there are negative sales (?!)
- the maximum of sales is huge


```{r head}
# customers of our client
customer_flows %>% head()
# shops of our client
client_shops %>% head()
```


```{r skim}
customer_flows %>% setDT()
customer_flows[, cl_id := as.factor(cl_id)]
skim(customer_flows[,-c("geometry")])

client_shops %>% setDT()
skim(client_shops[,-c("geometry")])
```



### Distributions

Look at the concentration of sales by customers.
We see that 10% of the clients account for 50% of the sales.
The same is true for the shops

```{r salesConcentrationCustomer}
customer_flows <- customer_flows[sales > 0,]
customer_flows[,sales_rank:=frank(-sales,ties.method = "random")]
setorder(customer_flows,sales_rank)

nb_customer <- nrow(customer_flows)
total_sales <- sum(customer_flows$sales)

customer_flows[order(sales_rank),cum_sales := cumsum(sales)]
customer_flows[order(sales_rank),rcum_sales := cum_sales / total_sales]
customer_flows[,client_no := sales_rank / nb_customer]

half_turnover <- customer_flows[rcum_sales < 0.5,] %>% nrow() / nb_customer 
half_turnover <- half_turnover %>% round(2)

ggplot(customer_flows) +
  geom_line(aes(x = sales_rank/nb_customer, y = 1 - rcum_sales)) +
  scale_x_continuous(breaks = c(seq(0,1,0.25),half_turnover),
                     name = "Percentage of Clients") +
  scale_y_continuous(name = "Percentage of turnover")
```

Concentration of sales by shop

```{r salesConcentrationShops}
sales_by_shop <- 
  customer_flows[, .(sales = sum(as.numeric(sales))), by = "pos_id"]
sales_by_shop[,sales_rank:=frank(-sales,ties.method = "random")]
setorder(sales_by_shop,sales_rank)
sales_by_shop[order(sales_rank),cum_sales := cumsum(sales)]
sales_by_shop[order(sales_rank),rcum_sales := cum_sales / total_sales]

half_turnover_shops <- sales_by_shop[rcum_sales < 0.5,] %>% nrow()

ggplot(sales_by_shop) +
  geom_line(aes(x = sales_rank, y = 1 - rcum_sales)) +
  scale_x_continuous(breaks = seq(0,65,10),name = "Number of shops") +
  scale_y_continuous(name = "Percentage of turnover")

```

### Spatial distributions

```{r baseMap, include=FALSE}
fr_base_map <- ggplot(departments) +
  geom_sf(fill = "grey95") +
  theme(
    title = element_text(),
    plot.title = element_text(
      margin = margin(20, 20, 20, 20),
      size = 18,
      hjust = 0.5),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.major = element_blank(),
    panel.background = element_blank()
  )
```

Where are where are the best shop?

```{r mapShops}
client_shops %>% setDT()
client_shops[sales_by_shop, sales := sales, on = "pos_id"]
client_shops %>% setorder(sales)

fr_base_map + 
  geom_sf(data = client_shops %>% st_as_sf(),
          mapping = aes(size = sqrt(sales),color = log(sales)), alpha = 0.8) +
  scale_color_continuous_sequential("YlGnBu")
```


Where are the best customers?

```{r mapCustomers}
best_customers <- customer_flows[rcum_sales < 0.5,]
best_customers %>% setorder(-sales_rank)


fr_base_map + 
  geom_sf(data = best_customers %>% st_as_sf(),
          mapping = aes(size = sqrt(sales),color = log(sales)), alpha = 0.5) +
  scale_color_continuous_sequential("YlGnBu")
```


What distance travel the customers?

```{r}

customer_flows[client_shops, DEST_LAT := pos_lat, on = "pos_id"]
customer_flows[client_shops, DEST_LON := pos_lon, on = "pos_id"]

customer_flows %>% add_pair_dist(orig_lat_col = "cl_lat",
                                 orig_lon_col = "cl_lon")

ggplot(customer_flows) +
  geom_density(aes(x = GC_DIST_KM, y = ..density..)) +
  geom_density(aes(x = GC_DIST_KM, y = ..density.., weight = sales),
               col = "red", fill = "red", alpha = 0.3) +
  scale_and_breaks_x_log10() +
  theme_rrMD()
```


# Does this distance vary a lot by shop?

```{r}
customer_flows[client_shops, DEST_LAT := pos_lat, on = "pos_id"]

my_quantile <- function(x, wt, probs) {
  cbind(tibble(qt = quantile(x, probs), probs = probs),
        tibble(wqt = Hmisc::wtd.quantile(x,wt, probs)))
        
}

customer_travel_quantiles <- customer_flows %>% 
  group_by(pos_id) %>% 
  summarise(my_quantile(GC_DIST_KM,sales,c(0.1,0.3,0.5,.7, .9))) %>% 
  setDT() 


ggplot(customer_travel_quantiles, aes(x = x, group = probs)) +
  geom_density(aes(x = qt,y = ..density.., fill = as.factor(probs)),
       alpha = 0.6) +
  geom_density(aes(x = wqt,y = -..density.., fill = as.factor(probs)),
       alpha = 0.6) +
  geom_hline(yintercept = 0, color = "red") +
  scale_fill_discrete_qualitative(palette = "Dynamic") +
  scale_and_breaks_x_log10() +
  scale_y_continuous() +
  geom_label( aes(x=Inf, y=1, label="Distance Quantiles (count)"), color="#404080",hjust =1) +
    geom_label( aes(x=Inf, y=-1, label="Distance Quantiles (sales)"), color="#404080",hjust =1) +

  theme_rrMD()
```

